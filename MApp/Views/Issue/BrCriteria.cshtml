@using PerpetuumSoft.Knockout
@model MApp.Web.ViewModel.BrCriteriaVM
@{
    ViewBag.Title = Model.Issue.Title + " - Criteria Brainstorming";
    var ko = Html.CreateKnockoutContext();
}

<h2><span data-bind="text: viewModel.Issue.Title"></span> - Criteria Brainstorming</h2>

<span>
    <table id="criteriaTable" class="table table-hover table-striped table-condensed table-nonfluid">
        <thead align="left">
            <tr>
                <th>Criterion name</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody data-bind="foreach: viewModel.IssueCriteria">
            <tr>
                @if (Model.AccessRight != "V" && Model.Issue.Status == "BRAINSTORMING1")
                {
                    <td><input data-bind="textInput: Name" class="form-control textbox-name" /></td>
                }
                else
                {
                    <td data-bind="text: Name"></td>
                }
                <td>
                    @if (Model.AccessRight != "V" && Model.Issue.Status == "BRAINSTORMING1")
                    {
                        <textarea data-bind="textInput: Description" class="form-control textarea-desc"></textarea>
                    }
                    else
                    {
                        <p data-bind="text: Description"></p>
                    }
                        
                    <table >
                        <thead>
                            <tr class="accordion-toggle" data-toggle="collapse" data-target=".comment">
                                <td>user</td>
                                <td>comment</td>
                            </tr>
                        </thead>
                        <tbody class="hiddenRow collapse comment">
                            <tr>
                                <td>User1</td>
                                <td>Some comment</td>
                            </tr>
                            <tr>
                                <td>User 2</td>
                                <td>Other comment</td>
                            </tr>
                        </tbody>
                    </table>
                    <button id="addComment" data-bind="visible: Id>'0'" class="btn btn-primary btn-xs" onclick="javascript: onAddCommentClick">Add new comment</button>
                </td>
                <td><button class="btn btn-danger btn-xs" href="#" data-bind="click: $parent.removeCriterion, visible: viewModel.AccessRight() != 'V', enable: viewModel.Issue.Status() =='BRAINSTORMING1'">Remove</button></td>
            </tr>
        </tbody>
    </table>
</span>

@if (Model.AccessRight == "C" || Model.AccessRight == "O")
{
    <button id="addNewCriterion" class="btn btn-primary btn-md" onclick="onAddNewCriterionClick()" data-bind="enable: viewModel.Issue.Status() == 'BRAINSTORMING1'">Add new Criterion</button>
    <button id="save" class="btn btn-success btn-md" onclick="onSaveClick()">Save</button>
}
@if (Model.AccessRight == "O")
{
    <button id="nextstage" type="button" class="btn btn-success" onclick="javascript: onNextStageClick()">Next Stage</button>
}


@ko.Apply(Model)

<script>
    renderMenues()
    var deletedCriteria = []

    viewModel.removeCriterion = function () {
        viewModel.IssueCriteria.remove(this);
        if (typeof this.Id == "function"){
            if (this.Id() > 0) {
            viewModel.DeletedCriteria.push(this.Id())
            }
        }

    };

    function onAddNewCriterionClick() {
        viewModel.IssueCriteria.push({ Id: -1, Name: "", Description: "", IssueId: viewModel.Issue.Id , Weigh: 0, WeightPC: 0})
    }

    function onSaveClick() {
        var tmpVM = ko.toJS(viewModel)
        ko.utils.postJson("", { BrCriteriaVM: tmpVM })
    }

    function onNextStageClick() {
        ko.utils.postJson("/Issue/NextStage", { issueId: viewModel.Issue.Id, status: viewModel.Issue.Status })
    };

    function onAddCommentClick() {

    }
</script>