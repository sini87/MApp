@using PerpetuumSoft.Knockout
@model MApp.Web.ViewModel.CriteriaWeightsVM
@{
    ViewBag.Title = Model.Issue.Title + " - Criteria Weighting";
    var ko = Html.CreateKnockoutContext();
}

<span>
    <table id="criteriaWeightsTable" class="table table-hover table-striped table-condensed table-nonfluid">
        <thead align="left">
            <tr>
                <th>Criteria</th>
                <th>Your Weight</th>
            </tr>
        </thead>
        <tbody data-bind="foreach: viewModel.UserWeights">
            <tr>
                <td><label data-bind="text: Name" class="form-control" /></td>
                <td><input data-bind="textInput: Weight" class="form-control"/></td>
            </tr>
        </tbody>
        <tr>
            <td><label id="sumlabel">Sum:</label></td>
            <td data-bind="text: viewModel.WeightSum"></td>
        </tr>
    </table>
</span>
@*<button id="save" class="btn btn-success btn-md" onclick="onSaveClick()">Save</button>
<button id="nextstage" type="button" class="btn btn-success" onclick="javascript: onNextStageClick()">Next Stage</button>*@

@ko.Apply(Model)

<script>
    renderMenues()

    viewModel.WeightSum = ko.computed(function () {
        var sum = 0;
        for (i = 0; i < viewModelJs.UserWeights.length; i++) {
            sum = sum + viewModelJs.UserWeights[0].Weight;
        }
        return sum;
    });

    function onSaveClick() {
        var tmpVM = ko.toJS(viewModel)
        ko.utils.postJson("", { CriteriaRatingVM: tmpVM })
    }

    function onNextStageClick() {
        $.ajax({
            url: '@Url.Action("NextStage","Issue")',
            type: 'POST',
            data: { issueId: viewModel.Issue.Id }
        })
        window.location.replace("/Issue/Evaluating?issueId=" + viewModelJs.Issue.Id)
    };

    function onAddCommentClick() {

    }

    function renderMenues() {
        var issueId = viewModelJs.Issue.Id;

        if (viewModelJs.Issue.Status == "FINISHED") {
            status = 5
        }
        if (viewModelJs.Issue.Status == "EVALUATING") {
            status = 4
        }
        if (viewModelJs.Issue.Status == "BRAINSTORMING2") {
            status = 3
        } else if (viewModelJs.Issue.Status == "BRAINSTORMING1") {
            status = 2
        } else {
            status = 1
        }

        if (status < 6) {
            var menuElem = document.getElementById("creating-menu")
            for (i = 0; i < menuElem.childNodes.length; i++) {
                if (menuElem.childNodes[i].nodeName == "A") {
                    menuElem.childNodes[i].innerHTML = 'Issue Overview';
                    menuElem.childNodes[i].href = "/Issue/Creating?issueId=" + issueId;
                    break;
                }
            }

            menuElem = document.getElementById("alternatives-menu")
            menuElem.childNodes[0].href = "/Issue/BrAlternatives?issueId=" + issueId;
            menuElem = document.getElementById("criteriafinding-menu")
            menuElem.childNodes[0].href = "/Issue/BrCriteria?issueId=" + issueId;
            menuElem = document.getElementById("criteriarating-menu")
            menuElem.childNodes[0].href = "/Issue/CriteriaRating?issueId=" + issueId;
            menuElem = document.getElementById("evaluating-menu")
            menuElem.childNodes[0].href = "/Issue/Evaluating?issueId=" + issueId;
            menuElem = document.getElementById("evaluating-menu")
            menuElem.childNodes[0].href = "/Issue/finished?issueId=" + issueId;
        }
        if (status < 5) {

            var menuElem = document.getElementById("finished-menu")
            menuElem.className = "disabled"
        }
        if (status < 4) {
            var menuElem = document.getElementById("evaluating-menu")
            menuElem.className = "disabled"
        }
        if (status < 3) {
            var menuElem = document.getElementById("criteriarating-menu")
            menuElem.className = "disabled"

        }
        if (status < 2) {
            var menuElem = document.getElementById("alternatives-menu")
            menuElem.className = "disabled"
            menuElem = document.getElementById("criteriafinding-menu")
            menuElem.className = "disabled"
        }
    }
</script>