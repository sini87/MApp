@using PerpetuumSoft.Knockout
@model List<MApp.Middleware.Models.UserIssueModel>
@{
    ViewBag.Title = "Issue Overvies";
    var ko = Html.CreateKnockoutContext();
}

<div class="page-header">
    <h2>Issue Overview</h2>
</div>

<table id="issueTable" class="tree table table-hover table-striped table-condensed">
    <thead>
        <tr>
            <th>Issue</th>
            <th class="td-center-top">Status</th>
            <th class="td-center-top">Action Required</th>
            <th>Unseen Infos</th>
            <th>Tags</th>
        </tr>
    </thead>
    <tbody data-bind="foreach: viewModel">
        <tr data-bind="css: treegrid">
            <td><a data-bind="text: Issue.Title, attr: { href: '/Issue/Creating?issueId=' + Issue.Id() }"></a></td>
            <td class="td-center-top">
                <!-- ko if: Issue.Status() == 'CREATING' -->
                    <a data-bind="attr: { href: '/Issue/Creating?issueId=' + Issue.Id() }">Creating</a> 
                <!-- /ko -->
                <!-- ko if: Issue.Status() == 'BRAINSTORMING1' -->
                    <p>Brainstorming</p>
                    <a data-bind="attr: { href: '/Issue/BrCriteria?issueId=' + Issue.Id() }">Criteria</a>
                    <a data-bind="attr: { href: '/Issue/BrAlternatives?issueId=' + Issue.Id() }">Alternatives</a>
                <!-- /ko -->
                <!-- ko if: Issue.Status() == 'BRAINSTORMING2' -->
                <p>Brainstorming</p>
                    <a data-bind="attr: { href: '/Issue/CriteriaRating?issueId=' + Issue.Id() }">Criteria Weighting</a>
                    <a data-bind="attr: { href: '/Issue/BrAlternatives?issueId=' + Issue.Id() }">Alternatives</a>
                <!-- /ko -->
                <!-- ko if: Issue.Status() == 'EVALUATING' -->
                    <a data-bind="attr: { href: '/Issue/Evaluation?issueId=' + Issue.Id() }">Evaluating</a>
                <!-- /ko -->
                <!-- ko if: Issue.Status() == 'DECIDING' -->
                    <a data-bind="attr: { href: '/Issue/Decision?issueId=' + Issue.Id() }">Deciding</a>
                <!-- /ko -->
                <!-- ko if: Issue.Status() == 'FINISHED' -->
                    <a data-bind="attr: { href: '/Issue/Decision?issueId=' + Issue.Id() }">Finished</a>
                <!-- /ko -->
            </td>
            <td class="td-center-top">
                <div data-bind="if: SelfAssessmentActionRequired">
                    <a data-bind="attr: { href: '/Issue/Creating?issueId=' + Issue.Id() }" class="actionrequired">Update Selfassessment!</a>
                </div>
                <div data-bind="if: CriteriaActionRatingRequired">
                    <a data-bind="attr: { href: '/Issue/CriteriaRating?issueId=' + Issue.Id() }" class="actionrequired">Weight Criteria!</a>
                </div>
                <div data-bind="if: EvaluationActionRequired" class="actionrequired">
                    <a data-bind="attr: { href: '/Issue/Evaluation?issueId=' + Issue.Id() }" class="actionrequired">Evaluate Alternatives!</a>
                </div>
            </td>
            <td class="td-center-top">
                <div class="ttip-large">
                    <label data-bind="text: UnreadCoreItemsCount, css: {actionrequired: newIssue, animated: newIssue, infinite: newIssue, flash: newIssue }"></label>
                    <!-- ko if: UnreadCoreItemsCount() > 0-->
                    <span class="tooltiptext" data-bind="foreach: UnreadCoreItems">
                        <p data-bind="text: $data"></p>
                    </span>
                    <!-- /ko -->
                </div>
            </td>
            <td data-bind="foreach: Issue.Tags">
                <a data-bind="text: Name" class="tag"></a>
            </td>
        </tr>
    </tbody>
</table>

<script type="text/javascript">
    var viewModelJs = @Html.Raw(Json.Encode(Model));
    for (var i = 0; i < viewModelJs.length; i++){
        var newIssue = false;
        viewModelJs[i].treegrid = 'treegrid-' + viewModelJs[i].Issue.Id;
        if (viewModelJs[i].Issue.Parent != null && viewModelJs[i].Issue.Parent != ""){
            viewModelJs[i].treegrid = viewModelJs[i].treegrid + ' treegrid-parent-' + viewModelJs[i].Issue.Parent;
        }
        for (var j = 0; j < viewModelJs[i].UnreadCoreItems.length; j++){
            if(viewModelJs[i].UnreadCoreItems[j].indexOf('Issue Information') >= 0){
                newIssue = true;
            }
        }
        viewModelJs[i].newIssue = newIssue
    }
    
    var viewModel = ko.mapping.fromJS(viewModelJs);

    ko.applyBindings(viewModel);


    $(document).ready(function () {
        $('.tree').treegrid();

        var element = document.getElementById("finished-menu");
        element.parentNode.removeChild(element);
        element = document.getElementById("brainstorming-menu");
        element.parentNode.removeChild(element);
        element = document.getElementById("creating-menu");
        element.parentNode.removeChild(element);
        element = document.getElementById("evaluating-menu");
        element.parentNode.removeChild(element);
    });
</script>